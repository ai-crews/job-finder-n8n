const allRows = $input.all();

// 1. ë‚ ì§œ ë° ì£¼ì°¨ ê³„ì‚° (ì˜¤ëŠ˜: 2026-02-28)
const now = new Date();
const todayStr = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;
const weekTitle = `${now.getMonth() + 1}ì›” ${Math.ceil(now.getDate() / 7)}ì£¼ì°¨`;
const myAppUrl = "https://job-finder-web-production.up.railway.app";

// 2. D-Day ê³„ì‚° í•¨ìˆ˜
function getDDay(deadlineStr) {
  if (!deadlineStr || deadlineStr === "9999-12-31") return "ìƒì‹œ";
  const target = new Date(deadlineStr);
  const diff = Math.ceil((target - now) / (1000 * 60 * 60 * 24));
  return diff <= 0 ? "D-0" : `D-${diff}`;
}

// 3. ì‚¬ìš©ìë³„ ë°ì´í„° ê·¸ë£¹í™”
const usersMap = {};

for (const row of allRows) {
  const data = row.json;
  const email = data['ì´ë©”ì¼'] || data.user_email;
  const type = data['ë ˆì´ì–´ êµ¬ë¶„(ë§ì¶¤í˜•/ë§ˆê°ìˆœí˜•/íƒìƒ‰í˜•)'] || "";
  const sortingCriterion = data['ìˆœì„œ ì„ íƒ(ë§ˆê°ìˆœ/ì¶”ì²œìˆœ)'] || "";

  if (!usersMap[email]) {
    usersMap[email] = {
      userName: data['ì§€ì›ì ì„±í•¨'] || "êµ¬ë…ì",
      userEmail: email,
      sortingCriterion: sortingCriterion,
      matchedJobs: [],
      explorationJobs: []
    };
  }

  const cleanText = (val) => String(val || "").replace(/[\[\]']/g, "");

  const jobEntry = {
    company_name: cleanText(data['ì¶”ì²œ ê¸°ì—…ëª… (company_name)']),
    position_name: cleanText(data['ì¶”ì²œ ê³µê³ ëª… (job_title)']),
    job_role: cleanText(data['processed_position_name']), 
    employment_type: cleanText(data['processed_employment_type']) || "ì •ê·œì§",
    logo_url: data['ê¸°ì—…ë¡œê·¸ ì´ë¯¸ì§€URL'] || "",
    apply_url: data['ì±„ìš©ê³µê³ URL (job_url)'] || "#",
    deadline: data['application_deadline_date'] || "9999-12-31",
    rank: parseInt(data['rank']) || 999
  };

  if (type.includes("ë§ì¶¤í˜•") || type.includes("ë§ˆê°ìˆœí˜•")) {
    usersMap[email].matchedJobs.push(jobEntry);
  } else if (type.includes("íƒìƒ‰í˜•")) {
    usersMap[email].explorationJobs.push(jobEntry);
  }
}

// ì‚¬ìš©ìë³„ ì •ë ¬
for (const email in usersMap) {
  const user = usersMap[email];
  const isRecommended = user.sortingCriterion.includes("ì¶”ì²œìˆœ");
  const sortFn = (a, b) => isRecommended ? (a.rank - b.rank) : a.deadline.localeCompare(b.deadline);
  user.matchedJobs.sort(sortFn);
  user.explorationJobs.sort(sortFn);
}

// 4. ì¡ ì¹´ë“œ ìƒì„± í•¨ìˆ˜ (userName ë§¤ê°œë³€ìˆ˜ ì¶”ê°€)
function generateJobCard(job, userEmail, userName) {
  const dDay = getDDay(job.deadline);
  
  // ğŸ¯ $input.first() ëŒ€ì‹  ì „ë‹¬ë°›ì€ userNameì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
  const params = [
    `url=${encodeURIComponent(job.apply_url)}`,
    `company=${encodeURIComponent(job.company_name)}`,
    `job_title=${encodeURIComponent(job.job_role)}`, 
    `recruitment_title=${encodeURIComponent(job.position_name)}`,
    `source=email`,
    `user_identifier=${encodeURIComponent(userName)}` 
  ].join('&');

  const applyUrl = `${myAppUrl}/?${params}`;

  return `
<table width="100%" style="border:1px solid #E8E8E8; background:#ffffff; margin-bottom:15px; border-radius:10px; border-collapse:separate; box-shadow: 0 2px 4px rgba(0,0,0,0.05);" cellpadding="0" cellspacing="0">
  <tr><td style="padding:15px;">
    <table width="100%" cellpadding="0" cellspacing="0">
      <tr>
        <td width="60" valign="top" style="padding-right:15px;">
          ${job.logo_url ? `<img src="${job.logo_url}" width="60" style="border-radius:8px;">` : `<div style="width:60px; height:60px; background:#F5F5F5; border-radius:8px; text-align:center; line-height:60px; font-size:10px; color:#AAA;">LOGO</div>`}
        </td>
        <td valign="top">
          <table width="100%" style="font-family:'Roboto', sans-serif; font-size:12px; line-height:1.5;">
            <tr><td width="50" style="color:#888888 !important;">ê¸°ì—…</td><td style="font-weight:bold; font-size:14px; color:#333333 !important;">${job.company_name}</td></tr>
            <tr><td style="color:#888888 !important;">ê³µê³ ëª…</td><td style="font-size:13px; color:#333333 !important;">${job.position_name}</td></tr>
            <tr><td style="color:#888888 !important;">ê³ ìš©í˜•íƒœ</td><td>
              <span style="color:#007BFF !important; background:#E7F3FF !important; padding:1px 6px; border-radius:4px; font-weight:bold; font-size:10px; margin-right:4px;">ì‹ ì…</span>
              <span style="color:#FD7E14 !important; background:#FFF3E6 !important; padding:1px 6px; border-radius:4px; font-weight:bold; font-size:10px;">${job.employment_type}</span>
            </td></tr>
            <tr><td style="color:#888888 !important;">ë§ˆê°ì¼ì</td><td style="font-weight:bold; color:#333333 !important;">
              <span style="color:#D93025 !important;">${dDay}</span> | ${job.deadline === "9999-12-31" ? "ìƒì‹œì±„ìš©" : job.deadline}
            </td></tr>
          </table>
        </td>
        <td width="70" align="right" valign="bottom">
            <a href="${applyUrl}" target="_blank" style="font-family:'Roboto', sans-serif; font-size:11px; color:#333333 !important; text-decoration:none; border-bottom:1px solid #333333; font-weight:bold;">ë°”ë¡œê°€ê¸° ></a>
        </td>
      </tr>
    </table>
  </td></tr>
</table>`;
}

// 5. ìµœì¢… ê²°ê³¼ ìƒì„±
const results = [];
for (const email in usersMap) {
  const user = usersMap[email];
  
  // ğŸ¯ í˜¸ì¶œ ì‹œ user.userNameì„ ì„¸ ë²ˆì§¸ ì¸ìë¡œ ë„˜ê²¨ì¤ë‹ˆë‹¤.
  const matchedHtml = user.matchedJobs.length > 0 ? `
    <div style="background:#9BC988; color:#3E5F44 !important; padding:6px 12px; border-radius:4px; font-weight:bold; font-size:13px; margin-bottom:15px;">
      <table width="100%"><tr><td style="color:#3E5F44 !important; font-weight:bold;">ğŸ“Œ ë§ì¶¤í˜• ì±„ìš©ê³µê³ </td><td align="right" style="color:#3E5F44 !important; font-size:10px; font-weight:normal; opacity:0.8;">${user.sortingCriterion}</td></tr></table>
    </div>
    ${user.matchedJobs.slice(0, 5).map(j => generateJobCard(j, user.userEmail, user.userName)).join("")}` : `
    <div style="text-align:center; padding:30px 20px; color:#333333 !important; font-size:14px; background:#ffffff; border:1px dashed #E8E8E8; border-radius:10px; margin-bottom:20px;">
      <b>ê¸ˆì£¼ ë§ì¶¤í˜• ì±„ìš©ê³µê³ ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ìš”.</b><br>ëŒ€ì‹  ì•„ë˜ <b>${user.userName}ë‹˜</b>ì´ ëˆˆì—¬ê²¨ ë³´ë©´ ì¢‹ì„ ê³µê³ ë¥¼ ì¶”ì²œí•´ë“œë ¤ìš”!
    </div>`;

  const explorationHtml = user.explorationJobs.length > 0 ? `
    <div style="margin-top:25px;">
      <div style="background:#9BC988; color:#3E5F44 !important; padding:6px 12px; border-radius:4px; font-weight:bold; font-size:13px; margin-bottom:15px;">
        <table width="100%"><tr><td style="color:#3E5F44 !important; font-weight:bold;">ğŸš€ íƒìƒ‰í˜• ì±„ìš©ê³µê³ </td><td align="right" style="color:#3E5F44 !important; font-size:10px; font-weight:normal; opacity:0.8;">${user.sortingCriterion}</td></tr></table>
      </div>
      ${user.explorationJobs.slice(0, 5).map(j => generateJobCard(j, user.userEmail, user.userName)).join("")}
    </div>` : "";

  const fullHtml = `
<!DOCTYPE html>
<html>
<head><link href="https://fonts.googleapis.com/css2?family=Alatsi&family=Roboto:wght@400;700&display=swap" rel="stylesheet"></head>
<body style="margin:0; padding:0; background-color:#F4F4F4; font-family:'Roboto', sans-serif;">
  <table width="100%" style="background-color:#F4F4F4; padding:20px 10px;">
    <tr><td>
      <table width="100%" style="max-width:600px; background:#ffffff; margin:0 auto; overflow:hidden;" cellpadding="0" cellspacing="0">
        <tr><td style="background:#3E5F44; padding:30px 25px; color:#ffffff !important;">
          <div style="font-size:22px; font-weight:bold; margin-bottom:8px; color:#ffffff !important;">ğŸ” ${weekTitle} ì±„ìš©ê³µê³  ë„ì°©!</div>
          <div style="font-size:12px; opacity:0.9; color:#ffffff !important;">'ë°”ë¡œê°€ê¸°'ë¥¼ í´ë¦­í•˜ë©´ ë” ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆì–´ìš”.</div>
          <div style="text-align:right; font-size:10px; opacity:0.6; color:#ffffff !important; margin-top:10px;">${todayStr}</div>
        </td></tr>
        <tr><td style="padding:30px 25px;">
          <div style="font-size:16px; color:#000000 !important; font-weight:bold; margin-bottom:25px;">${user.userName}ë‹˜ì´ ì„¤ì •í•˜ì‹  ì¡°ê±´ì— ì í•©í•œ ìˆœìœ¼ë¡œ ë³´ì—¬ë“œë ¤ìš”!</div>
          ${matchedHtml}
          ${explorationHtml}
          <div style="text-align:center; margin-top:40px;">
            <a href="${myAppUrl}" style="display:inline-block; background:#3E5F44; color:#ffffff !important; padding:14px 30px; text-decoration:none; border-radius:6px; font-weight:bold; font-size:13px;">ìˆ˜ì‹œì±„ìš©ê³µê³  ë³´ëŸ¬ê°€ê¸° ></a>
          </div>
        </td></tr>
        <tr><td style="background:#E8E8E8; padding:40px 25px; text-align:center;">
          <div style="font-family:'Alatsi', sans-serif; font-size:24px; font-weight:bold; color:#3E5F44 !important; margin-bottom:15px;">JOB FINDER</div>
          <div style="font-size:11px; color:#888888 !important; line-height:1.8;">
            <b style="color:#666666 !important;">Job Finderë¥¼ ë§Œë“  ì‚¬ëŒë“¤</b><br>
            ì„ì†Œí˜„ | ìµœì§€í˜œ | ê¹€ê·œì—° | ë°•ìˆ˜ë¯¼ | ì´ìˆ˜ì§„<br>ìµœí˜œì§€ | ì†”ë¡  | í˜„ì¬ | í™©ì¸ì„± | ê¹€ì£¼ì€
          </div>
        </td></tr>
        <tr><td style="background:#3E5F44; height:10px;"></td></tr>
      </table>
    </td></tr>
  </table>
</body>
</html>`;

  results.push({ json: { to: user.userEmail, subject: `[Job Finder] ${user.userName}ë‹˜ì„ ìœ„í•œ ì´ë²ˆ ì£¼ ì±„ìš©ê³µê³ ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤!`, html: fullHtml } });
}

return results;
