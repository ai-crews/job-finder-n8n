const allRows = $input.all();

// 1. ë‚ ì§œ ë° ì£¼ì°¨ ê³„ì‚° (ì˜¤ëŠ˜: 2026-02-28 ê¸°ì¤€)
const now = new Date();
const todayStr = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;
const weekTitle = `${now.getMonth() + 1}ì›” ${Math.ceil(now.getDate() / 7)}ì£¼ì°¨`;
const myAppUrl = "https://job-finder-web-production.up.railway.app";

// 2. D-Day ê³„ì‚° í•¨ìˆ˜
function getDDay(deadlineStr) {
  if (!deadlineStr || deadlineStr === "9999-12-31") return "ìƒì‹œ";
  const target = new Date(deadlineStr);
  const diff = Math.ceil((target - now) / (1000 * 60 * 60 * 24));
  return diff <= 0 ? "D-0" : `D-${diff}`;
}

// 3. ì‚¬ìš©ìë³„ ë°ì´í„° ê·¸ë£¹í™”
const usersMap = {};

for (const row of allRows) {
  const data = row.json;
  const email = data['ì´ë©”ì¼'] || data.user_email;
  const type = data['ë ˆì´ì–´ êµ¬ë¶„(ë§ì¶¤í˜•/ë§ˆê°ìˆœí˜•/íƒìƒ‰í˜•)'] || "";
  const sortingCriterion = data['ìˆœì„œ ì„ íƒ(ë§ˆê°ìˆœ/ì¶”ì²œìˆœ)'] || "";

  if (!usersMap[email]) {
    usersMap[email] = {
      userName: data['ì§€ì›ì ì„±í•¨'] || "êµ¬ë…ì",
      userEmail: email,
      sortingCriterion: sortingCriterion,
      matchedJobs: [],
      explorationJobs: []
    };
  }

  const cleanText = (val) => String(val || "").replace(/[\[\]']/g, "");

  const jobEntry = {
    company_name: cleanText(data['ì¶”ì²œ ê¸°ì—…ëª… (company_name)']),
    position_name: cleanText(data['ì¶”ì²œ ê³µê³ ëª… (job_title)']),
    job_role: cleanText(data['processed_position_name']), 
    employment_type: cleanText(data['processed_employment_type']) || "ì •ê·œì§",
    logo_url: data['ê¸°ì—…ë¡œê·¸ ì´ë¯¸ì§€URL'] || "",
    apply_url: data['ì±„ìš©ê³µê³ URL (job_url)'] || "#",
    deadline: data['application_deadline_date'] || "9999-12-31",
    rank: parseInt(data['rank']) || 999
  };

  if (type.includes("ë§ì¶¤í˜•") || type.includes("ë§ˆê°ìˆœí˜•")) {
    usersMap[email].matchedJobs.push(jobEntry);
  } else if (type.includes("íƒìƒ‰í˜•")) {
    usersMap[email].explorationJobs.push(jobEntry);
  }
}

// ì‚¬ìš©ìë³„ ì •ë ¬ ë¡œì§ (ì¶”ì²œìˆœ/ë§ˆê°ìˆœ)
for (const email in usersMap) {
  const user = usersMap[email];
  const isRecommended = user.sortingCriterion.includes("ì¶”ì²œìˆœ");
  const sortFn = (a, b) => isRecommended ? (a.rank - b.rank) : a.deadline.localeCompare(b.deadline);
  user.matchedJobs.sort(sortFn);
  user.explorationJobs.sort(sortFn);
}

// 4. ì¡ ì¹´ë“œ ìƒì„± í•¨ìˆ˜ (í•­ëª© ê³µë°± ì œê±° ë° ì™¼ìª½ ì •ë ¬)
function generateJobCard(job, userEmail, userName) {
  const dDay = getDDay(job.deadline);
  const params = [
    `url=${encodeURIComponent(job.apply_url)}`,
    `company=${encodeURIComponent(job.company_name)}`,
    `job_title=${encodeURIComponent(job.job_role)}`, 
    `recruitment_title=${encodeURIComponent(job.position_name)}`,
    `source=email`,
    `user_identifier=${encodeURIComponent(userName)}` 
  ].join('&');

  const applyUrl = `${myAppUrl}/?${params}`;

  return `
<table width="600" style="width:600px !important; border:1px solid #E3E8EF; background-color:#F9FAFC; margin-bottom:12px; border-radius:10px; border-collapse:separate;" cellpadding="0" cellspacing="0">
  <tr><td style="padding:18px;"> 
    <table width="100%" cellpadding="0" cellspacing="0">
      <tr>
        <td width="60" valign="top" style="padding-right:15px; width:60px !important;"> 
          ${job.logo_url ? `<img src="${job.logo_url}" width="60" style="border-radius:8px; display:block;">` : `<div style="width:60px; height:60px; background-color:#ffffff; border:1px solid #E3E8EF; border-radius:8px; text-align:center; line-height:60px; font-size:11px; color:#AAAAAA;">LOGO</div>`}
        </td>
        <td valign="top">
          <table width="100%" cellpadding="0" cellspacing="0" style="font-family:'Roboto', sans-serif; font-size:14px; line-height:1.8;"> 
            <tr><td width="55" style="color:#888888 !important; white-space:nowrap; text-align:left;">ê¸°ì—…</td><td style="font-weight:bold; font-size:16px; color:#333333 !important; padding-left:10px; text-align:left;">${job.company_name}</td></tr>
            <tr><td width="55" style="color:#888888 !important; white-space:nowrap; text-align:left;">ê³µê³ ëª…</td><td style="font-size:15px; color:#333333 !important; padding-left:10px; text-align:left;">${job.position_name}</td></tr>
            <tr><td width="55" style="color:#888888 !important; white-space:nowrap; text-align:left;">ê³ ìš©í˜•íƒœ</td><td style="white-space:nowrap; padding-left:10px; text-align:left;">
              <span style="display:inline-block; color:#007BFF !important; background-color:#E7F3FF !important; padding:2px 8px; border-radius:4px; font-weight:bold; font-size:11px;">ì‹ ì…</span>&nbsp;
              <span style="display:inline-block; color:#FD7E14 !important; background-color:#FFF3E6 !important; padding:2px 8px; border-radius:4px; font-weight:bold; font-size:11px;">${job.employment_type}</span>
            </td></tr>
            <tr><td width="55" style="color:#888888 !important; white-space:nowrap; text-align:left;">ë§ˆê°ì¼ì</td><td style="font-weight:bold; color:#333333 !important; white-space:nowrap; padding-left:10px; text-align:left;">
              <span style="color:#D93025 !important;">${dDay}</span>&nbsp;|&nbsp;${job.deadline === "9999-12-31" ? "ìƒì‹œì±„ìš©" : job.deadline}
            </td></tr>
          </table>
        </td>
        <td width="70" align="right" valign="bottom" style="width:70px !important;">
            <a href="${applyUrl}" target="_blank" style="font-family:'Roboto', sans-serif; font-size:12px; color:#333333 !important; text-decoration:none; border-bottom:1px solid #333333; font-weight:bold;">ë°”ë¡œê°€ê¸°&nbsp;></a>
        </td>
      </tr>
    </table>
  </td></tr>
</table>`;
}

// 5. ìµœì¢… HTML ìƒì„±
const results = [];
for (const email in usersMap) {
  const user = usersMap[email];
  const badgeStyle = `background:#9BC988 !important; background-image:linear-gradient(#9BC988, #9BC988) !important; color:#000000 !important; font-weight:bold; font-size:14px; padding:10px 15px; border-radius:4px;`;
  const hrStyle = `border: 0; border-top: 1px solid #EEEEEE; margin: 40px 0;`; // ğŸ¯ ê°€ë¡œì„  ìŠ¤íƒ€ì¼

  let matchedHtml = "";
  let explorationTitle = "";

  if (user.matchedJobs.length > 0) {
    matchedHtml = `
      <div style="${badgeStyle} margin-bottom:15px;">
        <table width="100%" cellpadding="0" cellspacing="0">
          <tr>
            <td align="left" style="color:#000000 !important; font-weight:bold; font-size:14px; white-space:nowrap;">ğŸ“Œ&nbsp;ë§ì¶¤í˜•&nbsp;ì±„ìš©ê³µê³ </td>
            <td align="right" style="color:#000000 !important; font-size:11px; font-weight:normal; opacity:0.7; white-space:nowrap;">${user.sortingCriterion}</td>
          </tr>
        </table>
      </div>
      ${user.matchedJobs.slice(0, 5).map(j => generateJobCard(j, user.userEmail, user.userName)).join("")}`;
    explorationTitle = `<div style="font-size:18px; color:#000000 !important; font-weight:bold; margin-top:30px; margin-bottom:15px;">${user.userName}ë‹˜ì´&nbsp;ëˆˆì—¬ê²¨&nbsp;ë³´ë©´&nbsp;ì¢‹ì„&nbsp;ê³µê³ ë¥¼&nbsp;ì¶”ì²œí•´ë“œë ¤ìš”!</div>`;
  } else {
    matchedHtml = `
      <div style="${badgeStyle} margin-bottom:15px;">
        <table width="100%" cellpadding="0" cellspacing="0">
          <tr>
            <td align="left" style="color:#000000 !important; font-weight:bold; font-size:14px; white-space:nowrap;">ğŸ“Œ&nbsp;ë§ì¶¤í˜•&nbsp;ì±„ìš©ê³µê³ </td>
            <td align="right" style="color:#000000 !important; font-size:11px; font-weight:normal; opacity:0.7; white-space:nowrap;">${user.sortingCriterion}</td>
          </tr>
        </table>
      </div>
      <div style="text-align:center; padding:50px 20px; color:#333333 !important; font-size:15px; background-color:#ffffff; border:1px dashed #E3E8EF; border-radius:10px; margin-bottom:20px;">
        <b>ê¸ˆì£¼&nbsp;ë§ì¶¤í˜•&nbsp;ì±„ìš©ê³µê³ ê°€&nbsp;ì¡´ì¬í•˜ì§€&nbsp;ì•Šì•„ìš”.</b><br>ëŒ€ì‹ &nbsp;ì•„ë˜&nbsp;<b>${user.userName}ë‹˜</b>ì´&nbsp;ëˆˆì—¬ê²¨&nbsp;ë³´ë©´&nbsp;ì¢‹ì„&nbsp;ê³µê³ ë¥¼&nbsp;ì¶”ì²œí•´ë“œë ¤ìš”!
      </div>`;
    explorationTitle = `<div style="font-size:18px; color:#000000 !important; font-weight:bold; margin-top:30px; margin-bottom:15px;">Job&nbsp;Finderê°€&nbsp;${user.userName}ë‹˜ê»˜&nbsp;ì¶”ì²œí•˜ëŠ”&nbsp;ê³µê³ </div>`;
  }

  const explorationHtml = user.explorationJobs.length > 0 ? `
    <div style="${hrStyle}"></div> ${explorationTitle}
    <div style="${badgeStyle} margin-bottom:15px;">
      <table width="100%" cellpadding="0" cellspacing="0">
        <tr>
          <td align="left" style="color:#000000 !important; font-weight:bold; font-size:14px; white-space:nowrap;">ğŸ“Œ&nbsp;íƒìƒ‰í˜•&nbsp;ì±„ìš©ê³µê³ </td>
          <td align="right" style="color:#000000 !important; font-size:11px; font-weight:normal; opacity:0.7; white-space:nowrap;">${user.sortingCriterion}</td>
        </tr>
      </table>
    </div>
    ${user.explorationJobs.slice(0, 5).map(j => generateJobCard(j, user.userEmail, user.userName)).join("")}` : "";

  const isRecommended = user.sortingCriterion.includes("ì¶”ì²œìˆœ");
  const headerMent = isRecommended 
    ? `${user.userName}ë‹˜ì´&nbsp;ì„¤ì •í•˜ì‹ &nbsp;ì¡°ê±´ì—&nbsp;ì í•©í•œ&nbsp;ìˆœìœ¼ë¡œ&nbsp;ë³´ì—¬ë“œë ¤ìš”!`
    : `${user.userName}ë‹˜&nbsp;ë§ì¶¤í˜•&nbsp;ê³µê³ ë¥¼&nbsp;ë§ˆê°ê¸°í•œ&nbsp;ìˆœìœ¼ë¡œ&nbsp;ë³´ì—¬ë“œë ¤ìš”!`;

  const fullHtml = `
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ko">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=600" />
  <link href="https://fonts.googleapis.com/css2?family=Alatsi&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body style="margin:0; padding:0; background-color:#F4F4F4; font-family:'Roboto', sans-serif;">
  <center>
    <table width="600" style="width:600px !important; background-color:#F4F4F4; padding:20px 0;" cellpadding="0" cellspacing="0" border="0">
      <tr><td>
        <table width="600" style="width:600px !important; background-color:#ffffff; margin:0 auto; overflow:hidden; border-collapse:collapse;" cellpadding="0" cellspacing="0" border="0">
          <tr><td style="background-color:#3E5F44; padding:35px 25px;">
            <table width="100%" cellpadding="0" cellspacing="0" border="0">
              <tr>
                <td>
                  <div style="font-size:24px; font-weight:bold; margin-bottom:10px; color:#FFC93E !important;">ğŸ“Œ&nbsp;${weekTitle}&nbsp;ì±„ìš©ê³µê³ &nbsp;ë„ì°©!</div>
                  <div style="font-size:13px; color:#ffffff !important; opacity:0.9;">'ë°”ë¡œê°€ê¸°'ë¥¼&nbsp;í´ë¦­í•˜ë©´&nbsp;ë”&nbsp;ìì„¸í•œ&nbsp;ì •ë³´ë¥¼&nbsp;í™•ì¸í•˜ì‹¤&nbsp;ìˆ˜&nbsp;ìˆì–´ìš”.</div>
                </td>
                <td align="right" valign="bottom" style="font-size:12px; color:#ffffff !important; opacity:0.6;">${todayStr}</td>
              </tr>
            </table>
          </td></tr>
          
          <tr><td style="padding:35px 25px;">
            <div style="font-size:18px; color:#000000 !important; font-weight:bold; margin-bottom:30px;">${headerMent}</div>
            ${matchedHtml}
            ${explorationHtml}
            
            <div style="${hrStyle}"></div> <div style="text-align:center; margin-top:10px;">
              <div style="font-size:22px; font-weight:bold; color:#000000 !important; margin-bottom:15px;">Job&nbsp;FinderëŠ”&nbsp;ì§ì ‘&nbsp;ì„ ë³„í•œ&nbsp;ìˆ˜ì‹œì±„ìš©ê³µê³ ë„&nbsp;ì œê³µí•˜ê³ &nbsp;ìˆì–´ìš”!</div>
              <a href="${myAppUrl}" target="_blank" style="display:inline-block; background-color:#3E5F44; color:#ffffff !important; padding:16px 35px; text-decoration:none; border-radius:6px; font-weight:bold; font-size:14px;">ìˆ˜ì‹œì±„ìš©ê³µê³ &nbsp;ë³´ëŸ¬ê°€ê¸°&nbsp;></a>
            </div>

            <div style="text-align:center; margin-top:50px; padding-top:35px; border-top:1px solid #EEEEEE;">
              <div style="font-size:22px; font-weight:bold; color:#000000 !important; margin-bottom:15px;">ë°›ì•„&nbsp;ë³¸&nbsp;ì±„ìš©ê³µê³ ê°€&nbsp;ì–´ë– ì…¨ë‚˜ìš”?</div>
              <div style="font-size:14px; color:#666666 !important; line-height:1.7; margin-bottom:18px;">
                ì—¬ëŸ¬ë¶„ì˜&nbsp;ì´ìš©&nbsp;í›„ê¸°ë¥¼&nbsp;ë“¤ë ¤ì£¼ì„¸ìš”!<br>
                ì—¬ëŸ¬ë¶„ì˜&nbsp;ì·¨ì—…ì¤€ë¹„ì—&nbsp;ë”&nbsp;ë„ì›€ì´&nbsp;ë˜ëŠ”&nbsp;ì„œë¹„ìŠ¤ê°€&nbsp;ë˜ë„ë¡&nbsp;ë…¸ë ¥í• ê²Œìš”.
              </div>
              <a href="https://forms.gle/your-feedback-link" target="_blank" style="font-size:14px; color:#333333 !important; font-weight:bold; text-decoration:underline;">ì„œë¹„ìŠ¤&nbsp;í”¼ë“œë°±í•˜ëŸ¬&nbsp;ê°€ê¸°</a>
            </div>
          </td></tr>

          <tr><td style="background-color:#E8E8E8; padding:45px 25px; text-align:center;">
            <div style="font-family:'Alatsi', sans-serif; font-size:26px; font-weight:bold; color:#3E5F44 !important; margin-bottom:20px;">JOB&nbsp;FINDER</div>
            <div style="margin-bottom:25px; line-height:2.2;">
              <a href="${myAppUrl}" target="_blank" style="color:#000000 !important; text-decoration:underline; font-weight:bold; font-size:15px;">JOB&nbsp;FINDER&nbsp;ê³µì‹&nbsp;í˜ì´ì§€</a><br>
              <a href="https://job-finder.notion.site/FAQ-job-finder-web-production-up-railway-app" target="_blank" style="color:#000000 !important; text-decoration:underline; font-weight:bold; font-size:15px;">FAQ</a>
            </div>
            <div style="font-size:15px; color:#3E5F44 !important; line-height:1.8;">
              <a href="https://www.notion.so/2-OKR-2ebc59b0cf1980168318e4111f715cc7" target="_blank" style="color:#3E5F44 !important; text-decoration:underline; font-weight:bold; font-size:15px; display:inline-block; margin-bottom:8px;">Job&nbsp;Finderë¥¼&nbsp;ë§Œë“ &nbsp;ì‚¬ëŒë“¤</a><br>
              ì„ì†Œí˜„&nbsp;|&nbsp;ìµœì§€í˜œ&nbsp;|&nbsp;ê¹€ê·œì—°&nbsp;|&nbsp;ë°•ìˆ˜ë¯¼&nbsp;|&nbsp;ì´ìˆ˜ì§„<br />
              ìµœí˜œì§€&nbsp;|&nbsp;ì†”ë¡ &nbsp;|&nbsp;í˜„ì¬&nbsp;|&nbsp;í™©ì¸ì„±&nbsp;|&nbsp;ê¹€ì£¼ì€
            </div>
          </td></tr>
          <tr><td style="background-color:#3E5F44; height:10px;"></td></tr>
        </table>
      </td></tr>
    </table>
  </center>
</body>
</html>`;

  results.push({ json: { to: user.userEmail, subject: `[Job Finder] ${user.userName}ë‹˜ì„ ìœ„í•œ ì´ë²ˆ ì£¼ ì±„ìš©ê³µê³ ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤!`, html: fullHtml } });
}

return results;
