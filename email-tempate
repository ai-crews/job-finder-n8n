const allRows = $input.all();

// 1. ë‚ ì§œ ë° ì£¼ì°¨ ê³„ì‚°
const now = new Date();
const currentMonth = now.getMonth() + 1; 
const currentDay = now.getDate();
const currentWeek = Math.ceil(currentDay / 7); 
const weekTitle = `${currentMonth}ì›” ${currentWeek}ì£¼ì°¨`;
const todayStr = `${now.getFullYear()}.${String(currentMonth).padStart(2, '0')}.${String(currentDay).padStart(2, '0')}`;
const myAppUrl = "https://job-finder-web-production.up.railway.app"; 

// 2. ì‚¬ìš©ìë³„ ë°ì´í„° ê·¸ë£¹í™”
const usersMap = {};

for (const row of allRows) {
  const data = row.json;
  const email = data['ì´ë©”ì¼'] || data.user_email;
  const type = data['ë ˆì´ì–´ êµ¬ë¶„(ë§ì¶¤í˜•/ë§ˆê°ìˆœí˜•/íƒìƒ‰í˜•)'] || "";

  if (!usersMap[email]) {
    usersMap[email] = {
      userName: data['ì§€ì›ì ì„±í•¨'] || "êµ¬ë…ì",
      userEmail: email,
      matchedJobs: [],
      explorationJobs: []
    };
  }

  const jobEntry = {
    company_name: data['ì¶”ì²œ ê¸°ì—…ëª… (company_name)'] || "ê¸°ì—…ëª… ë¯¸ìƒ",
    position_name: data['ì¶”ì²œ ê³µê³ ëª… (job_title)'] || "ê³µê³  ì°¸ì¡°",
    logo_url: data['ê¸°ì—…ë¡œê·¸ ì´ë¯¸ì§€URL'] || "",
    apply_url: data['ì±„ìš©ê³µê³ URL (job_url)'] || "#",
    deadline: data['application_deadline_date'] || "ìƒì‹œì±„ìš©"
  };

  // [ë‹¨ìˆœí™”ëœ êµ¬ë¶„ ë¡œì§]
  // 'ë§ì¶¤í˜•' ë˜ëŠ” 'ë§ˆê°ìˆœí˜•' í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ ë§ì¶¤í˜•ìœ¼ë¡œ, 'íƒìƒ‰í˜•'ì´ë©´ íƒìƒ‰í˜•ìœ¼ë¡œ ë¶„ë¥˜
  if (type.includes("ë§ì¶¤í˜•") || type.includes("ë§ˆê°ìˆœí˜•")) {
    usersMap[email].matchedJobs.push(jobEntry);
  } else if (type.includes("íƒìƒ‰í˜•")) {
    usersMap[email].explorationJobs.push(jobEntry);
  }
}

// 3. ì¡ ì¹´ë“œ ìƒì„± í•¨ìˆ˜ (GA ì¶”ì  í¬í•¨)
function generateJobCard(job, userEmail) {
  const params = [
    `url=${encodeURIComponent(job.apply_url)}`,
    `company=${encodeURIComponent(job.company_name)}`,
    `job_title=${encodeURIComponent(job.position_name)}`,
    `recruitment_title=${encodeURIComponent(job.position_name)}`,
    `source=email`,
    `user_id=${encodeURIComponent(userEmail)}`
  ].join('&');

  const applyUrl = `${myAppUrl}/?${params}`;

  return `
<table width="100%" style="border:1px solid #e1e4e8; background:#ffffff; margin-bottom:12px; border-radius:12px; border-collapse:separate;" cellpadding="0" cellspacing="0">
  <tr><td style="padding:15px;">
    <table width="100%" cellpadding="0" cellspacing="0">
      <tr>
        <td width="55" valign="top" style="padding-right:12px;">
          ${job.logo_url ? `<img src="${job.logo_url}" width="55" style="border-radius:8px; border:1px solid #eee;">` : 
          `<div style="width:55px; height:55px; background:#f0f2f5; border-radius:8px; text-align:center; line-height:55px; font-size:10px; color:#999; border:1px solid #eee;">LOGO</div>`}
        </td>
        <td valign="top">
          <table width="100%" style="font-size:12px; color:#333; line-height:1.4;">
            <tr><td width="45" style="color:#888;">ê¸°ì—…</td><td style="font-weight:bold;">${job.company_name}</td></tr>
            <tr><td style="color:#888;">ê³µê³ ëª…</td><td style="font-size:11px;">${job.position_name}</td></tr>
            <tr><td style="color:#888;">ë§ˆê°ì¼ì</td><td style="font-weight:bold;">${job.deadline}</td></tr>
          </table>
        </td>
        <td width="60" align="right" valign="bottom">
            <a href="${applyUrl}" target="_blank" style="font-size:11px; color:#333; text-decoration:none; border-bottom:1px solid #333; font-weight:bold;">ë°”ë¡œê°€ê¸° ></a>
        </td>
      </tr>
    </table>
  </td></tr>
</table>`;
}

// 4. ìµœì¢… HTML ìƒì„±
const results = [];
for (const email in usersMap) {
  const user = usersMap[email];
  
  // ë§ì¶¤í˜• ì„¹ì…˜
  let matchedHtml = "";
  if (user.matchedJobs.length > 0) {
    matchedHtml = `
      <div style="background:#dee2e6; color:#495057; padding:4px 10px; border-radius:4px; font-size:12px; font-weight:bold; margin-bottom:12px; display:inline-block;">ğŸ“Œ ë§ì¶¤í˜• ì±„ìš©ê³µê³ </div>
      ${user.matchedJobs.map(j => generateJobCard(j, user.userEmail)).join("")}`;
  } else {
    matchedHtml = `
      <div style="background:#dee2e6; color:#495057; padding:4px 10px; border-radius:4px; font-size:12px; font-weight:bold; margin-bottom:12px; display:inline-block;">ğŸ“Œ ë§ì¶¤í˜• ì±„ìš©ê³µê³ </div>
      <div style="text-align:center; padding:30px 0; color:#444; font-size:13px; background:#fcfcfc; border:1px dashed #ddd; border-radius:12px;">
        ê¸ˆì£¼ ë§ì¶¤í˜• ì±„ìš©ê³µê³ ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ìš”.<br>
        ëŒ€ì‹  ì•„ë˜ ì¶”ì²œ ê³µê³ ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!
      </div>`;
  }

  // íƒìƒ‰í˜• ì„¹ì…˜
  let explorationHtml = "";
  if (user.explorationJobs.length > 0) {
    explorationHtml = `
      <div style="margin-top:25px;">
        <div style="background:#dee2e6; color:#495057; padding:4px 10px; border-radius:4px; font-size:12px; font-weight:bold; margin-bottom:12px; display:inline-block;">ğŸš€ íƒìƒ‰í˜• ì±„ìš©ê³µê³ </div>
        ${user.explorationJobs.map(j => generateJobCard(j, user.userEmail)).join("")}
      </div>`;
  }

  const fullHtml = `
<!DOCTYPE html>
<html>
<body style="margin:0; padding:0; background-color:#f4f7f6; font-family:'Apple SD Gothic Neo', sans-serif;">
  <table width="100%" cellpadding="0" cellspacing="0" style="background-color:#f4f7f6; padding:20px 0;">
    <tr><td>
      <table width="550" style="background:#ffffff; margin:0 auto; overflow:hidden;" cellpadding="0" cellspacing="0">
        <tr><td style="background:#4a6741; padding:20px; color:#ffffff;">
          <div style="font-size:18px; font-weight:bold; margin-bottom:5px;">ğŸ” ${weekTitle} ì±„ìš©ê³µê³  ë„ì°©!</div>
          <div style="text-align:right; font-size:10px; margin-top:10px; opacity:0.6;">${todayStr}</div>
        </td></tr>
        <tr><td style="padding:25px;">
          <div style="font-size:15px; color:#000; font-weight:bold; margin-bottom:20px;">${user.userName}ë‹˜ì„ ìœ„í•œ ë§ì¶¤í˜•/íƒìƒ‰í˜• ê³µê³ ì…ë‹ˆë‹¤!</div>
          ${matchedHtml}
          ${explorationHtml}
          <div style="text-align:center; margin-top:35px;">
            <a href="${myAppUrl}" style="display:inline-block; background:#6c8e61; color:#fff; padding:10px 25px; text-decoration:none; border-radius:5px; font-weight:bold; font-size:12px;">ìˆ˜ì‹œì±„ìš©ê³µê³  ë³´ëŸ¬ê°€ê¸° ></a>
          </div>
        </td></tr>
        <tr><td style="background:#e9ecef; padding:30px 25px; text-align:center; color:#666; font-size:10px;">
          <div style="font-size:15px; font-weight:bold; color:#495057; margin-bottom:10px;">JOB FINDER</div>
          <div style="color:#888;">ì„ì†Œí˜„ | ìµœì§€í˜œ | ê¹€ê·œì—° | ë°•ìˆ˜ë¯¼ | ì´ìˆ˜ì§„<br>ìµœí˜œì§€ | ì†”ë¡  | í˜„ì¬ | í™©ì¸ì„± | ê¹€ì£¼ì€</div>
        </td></tr>
        <tr><td style="background:#4a6741; height:15px;"></td></tr>
      </table>
    </td></tr>
  </table>
</body>
</html>`;

  results.push({
    json: {
      to: user.userEmail,
      subject: `[Job Finder] ${user.userName}ë‹˜ì„ ìœ„í•œ ì´ë²ˆ ì£¼ ì±„ìš©ê³µê³ ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤!`,
      html: fullHtml
    }
  });
}

return results;
